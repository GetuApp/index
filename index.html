<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tefera Yadeta Travel | Multi-Agent System</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- jsPDF Library for PDF Generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        :root {
            --primary: #2c3e50;
            --primary-dark: #1a252f;
            --secondary: #e74c3c;
            --accent: #3498db;
            --success: #27ae60;
            --light: #f8f9fa;
            --dark: #2c3e50;
            --gray: #7f8c8d;
            --light-gray: #ecf0f1;
            --border-radius: 10px;
            --box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #e4edf5 100%);
            color: var(--dark);
            line-height: 1.6;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        /* Login Page */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 80vh;
        }
        
        .login-card {
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            padding: 40px;
            width: 100%;
            max-width: 500px;
            text-align: center;
            border-top: 5px solid var(--accent);
        }
        
        .login-logo {
            font-size: 50px;
            color: var(--accent);
            margin-bottom: 20px;
        }
        
        .login-title {
            font-size: 28px;
            color: var(--primary);
            margin-bottom: 10px;
        }
        
        .login-subtitle {
            color: var(--gray);
            margin-bottom: 30px;
        }
        
        /* Header */
        .header {
            background: linear-gradient(to right, var(--primary), var(--primary-dark));
            color: white;
            border-radius: var(--border-radius);
            padding: 20px 30px;
            margin-bottom: 30px;
            box-shadow: var(--box-shadow);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .user-avatar {
            width: 40px;
            height: 40px;
            background: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary);
            font-weight: bold;
            overflow: hidden;
        }
        
        .user-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        /* Cloudflare Sync Status */
        .sync-status {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            margin-left: 15px;
            padding: 5px 10px;
            border-radius: 20px;
            background: rgba(255,255,255,0.1);
        }
        
        .sync-status.online {
            color: #27ae60;
        }
        
        .sync-status.offline {
            color: #e74c3c;
        }
        
        .sync-status.syncing {
            color: #f39c12;
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        /* Main Layout */
        .main-layout {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }
        
        @media (max-width: 1100px) {
            .main-layout {
                grid-template-columns: 1fr;
            }
        }
        
        /* Card Styles */
        .card {
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            padding: 25px;
            transition: var(--transition);
            border-top: 4px solid var(--accent);
        }
        
        .card-title {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--light-gray);
        }
        
        .card-title i {
            color: var(--accent);
            font-size: 20px;
        }
        
        .card-title h2 {
            font-size: 20px;
            font-weight: 600;
            color: var(--dark);
        }
        
        /* Form Styles */
        .form-group {
            margin-bottom: 18px;
        }
        
        .form-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        @media (max-width: 768px) {
            .form-row {
                flex-direction: column;
                gap: 0;
            }
        }
        
        .form-row .form-group {
            flex: 1;
        }
        
        label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: var(--dark);
            font-size: 14px;
        }
        
        .required::after {
            content: " *";
            color: var(--secondary);
        }
        
        .optional::after {
            content: " (optional)";
            color: var(--gray);
            font-weight: normal;
        }
        
        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-family: 'Poppins', sans-serif;
            font-size: 14px;
            transition: var(--transition);
            background-color: white;
        }
        
        .form-control:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }
        
        select:disabled {
            background-color: #f5f5f5;
            cursor: not-allowed;
        }
        
        /* Button Styles */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            font-family: 'Poppins', sans-serif;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            text-align: center;
        }
        
        .btn-primary {
            background: var(--primary);
            color: white;
        }
        
        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
        }
        
        .btn-success {
            background: var(--success);
            color: white;
        }
        
        .btn-success:hover {
            background: #219653;
            transform: translateY(-2px);
        }
        
        .btn-warning {
            background: var(--secondary);
            color: white;
        }
        
        .btn-warning:hover {
            background: #c0392b;
            transform: translateY(-2px);
        }
        
        .btn-accent {
            background: var(--accent);
            color: white;
        }
        
        .btn-accent:hover {
            background: #2980b9;
            transform: translateY(-2px);
        }
        
        .btn-light {
            background: var(--light-gray);
            color: var(--dark);
        }
        
        .btn-light:hover {
            background: #dde1e7;
            transform: translateY(-2px);
        }
        
        .btn-block {
            width: 100%;
        }
        
        .button-group {
            display: flex;
            gap: 12px;
            margin-top: 25px;
            flex-wrap: wrap;
        }
        
        /* Cloudflare Button */
        .cloudflare-btn {
            background: #f38020;
            color: white;
        }
        
        .cloudflare-btn:hover {
            background: #d6701c;
        }
        
        /* Fare Display */
        .fare-display {
            text-align: center;
            padding: 25px;
            background: linear-gradient(to right, #f8f9fa, #e9ecef);
            border-radius: var(--border-radius);
            margin-top: 20px;
            border: 2px dashed #c1c8d0;
        }
        
        .fare-label {
            font-size: 14px;
            color: var(--gray);
            margin-bottom: 8px;
        }
        
        .fare-amount {
            font-size: 40px;
            font-weight: 700;
            color: var(--accent);
        }
        
        .fare-currency {
            font-size: 18px;
            color: var(--gray);
        }
        
        /* Summary Cards */
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-top: 20px;
        }
        
        @media (max-width: 768px) {
            .summary-cards {
                grid-template-columns: 1fr;
            }
        }
        
        .summary-card {
            background: white;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            box-shadow: 0 3px 10px rgba(0,0,0,0.05);
            border-top: 3px solid var(--accent);
        }
        
        .summary-card:nth-child(2) {
            border-top-color: var(--success);
        }
        
        .summary-card:nth-child(3) {
            border-top-color: var(--secondary);
        }
        
        .summary-value {
            font-size: 24px;
            font-weight: 700;
            color: var(--dark);
            margin-bottom: 4px;
        }
        
        .summary-label {
            font-size: 12px;
            color: var(--gray);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        /* Data Table */
        .data-table-container {
            margin-top: 25px;
            overflow-x: auto;
            border-radius: var(--border-radius);
            border: 1px solid var(--light-gray);
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .data-table thead {
            background: linear-gradient(to right, var(--primary), var(--primary-dark));
            color: white;
        }
        
        .data-table th {
            padding: 15px 12px;
            text-align: left;
            font-weight: 600;
            font-size: 14px;
            white-space: nowrap;
        }
        
        .data-table tbody tr {
            border-bottom: 1px solid var(--light-gray);
            transition: var(--transition);
        }
        
        .data-table tbody tr:hover {
            background-color: #f8f9fa;
        }
        
        .data-table td {
            padding: 14px 12px;
            font-size: 13px;
        }
        
        .route-cell {
            font-weight: 500;
            color: var(--accent);
        }
        
        .fare-cell {
            font-weight: 600;
            color: var(--dark);
        }
        
        .action-cell {
            white-space: nowrap;
        }
        
        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--gray);
        }
        
        .empty-state i {
            font-size: 50px;
            margin-bottom: 15px;
            color: var(--light-gray);
        }
        
        .empty-state h3 {
            font-size: 18px;
            margin-bottom: 8px;
            color: var(--dark);
        }
        
        /* Toast Notification */
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: white;
            color: var(--dark);
            padding: 15px 20px;
            border-radius: 6px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.15);
            display: flex;
            align-items: center;
            gap: 12px;
            z-index: 1000;
            transform: translateX(100%);
            opacity: 0;
            transition: transform 0.3s ease, opacity 0.3s ease;
            border-left: 4px solid var(--success);
            max-width: 300px;
        }
        
        .toast.show {
            transform: translateX(0);
            opacity: 1;
        }
        
        .toast i {
            font-size: 20px;
            color: var(--success);
        }
        
        .toast.warning {
            border-left-color: var(--secondary);
        }
        
        .toast.warning i {
            color: var(--secondary);
        }
        
        /* Admin Panel */
        .admin-panel {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .admin-card {
            background: white;
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: var(--box-shadow);
            border-top: 4px solid var(--accent);
        }
        
        .agent-stats {
            display: flex;
            justify-content: space-between;
            margin-top: 15px;
        }
        
        /* Footer */
        .footer {
            text-align: center;
            padding: 20px;
            color: var(--gray);
            font-size: 13px;
            margin-top: 30px;
            border-top: 1px solid var(--light-gray);
        }
        
        /* Responsive */
        @media (max-width: 576px) {
            .login-card {
                padding: 25px 20px;
            }
            
            .header {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }
            
            .button-group {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
            }
            
            .fare-amount {
                font-size: 32px;
            }
        }
        
        /* Badge */
        .badge {
            display: inline-block;
            padding: 4px 8px;
            font-size: 11px;
            font-weight: 600;
            border-radius: 4px;
            margin-left: 5px;
        }
        
        .badge-success {
            background: #d4edda;
            color: #155724;
        }
        
        .badge-warning {
            background: #fff3cd;
            color: #856404;
        }
        
        .badge-primary {
            background: #d1ecf1;
            color: #0c5460;
        }
        
        /* Telegram Button */
        .telegram-btn {
            background: #0088cc;
            color: white;
        }
        
        .telegram-btn:hover {
            background: #0077b5;
        }
        
        /* PDF Button */
        .pdf-btn {
            background: #e74c3c;
            color: white;
        }
        
        .pdf-btn:hover {
            background: #c0392b;
        }
        
        /* Email Button */
        .email-btn {
            background: #f39c12;
            color: white;
        }
        
        .email-btn:hover {
            background: #d68910;
        }
        
        /* Hidden Elements */
        .hidden {
            display: none;
        }
        
        /* Agent Select */
        .agent-select-card {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .agent-option {
            background: var(--light-gray);
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
            border: 2px solid transparent;
        }
        
        .agent-option:hover {
            border-color: var(--accent);
            background: #e3f2fd;
            transform: translateY(-3px);
        }
        
        .agent-option.selected {
            border-color: var(--accent);
            background: #e3f2fd;
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.2);
        }
        
        .agent-photo {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            object-fit: cover;
            margin-bottom: 10px;
            border: 3px solid var(--accent);
        }
        
        .agent-option h3 {
            font-size: 16px;
            margin-bottom: 5px;
            color: var(--dark);
        }
        
        .agent-option p {
            font-size: 12px;
            color: var(--gray);
        }
        
        /* Route Info */
        .route-info {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            font-size: 13px;
            color: var(--gray);
            border-left: 3px solid var(--accent);
        }
        
        .route-info i {
            color: var(--accent);
            margin-right: 8px;
        }
        
        /* Profile Photo Section */
        .profile-section {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .profile-photo {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid var(--accent);
        }
        
        /* Print Styles */
        @media print {
            .no-print {
                display: none !important;
            }
            
            body {
                background: white;
                padding: 0;
            }
            
            .card {
                box-shadow: none;
                border: 1px solid #ddd;
            }
            
            .header {
                background: white !important;
                color: black !important;
                border: 1px solid #ddd;
            }
        }
        
        /* Cloudflare Sync Panel */
        .sync-panel {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
            border-left: 4px solid #f38020;
        }
        
        .sync-panel h4 {
            color: #24292e;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        /* Telegram Status */
        .telegram-status {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            margin-left: 15px;
            padding: 5px 10px;
            border-radius: 20px;
            background: rgba(255,255,255,0.1);
        }
        
        .telegram-status.connected {
            color: #27ae60;
        }
        
        .telegram-status.disconnected {
            color: #e74c3c;
        }
        
        /* Loading Spinner */
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--accent);
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- Login Page -->
    <div id="loginPage" class="container">
        <div class="login-container">
            <div class="login-card">
                <div class="login-logo">
                    <i class="fas fa-bus"></i>
                </div>
                <h1 class="login-title">Tefera Yadeta Travel Agent</h1>
                <p class="login-subtitle">Cloudflare Pages + Telegram Bot System</p>
                
                <div class="route-info">
                    <i class="fas fa-cloud"></i> This system is deployed on Cloudflare Pages with real-time Telegram notifications.
                </div>
                
                <div class="form-group">
                    <label for="userType">Select User Type</label>
                    <select id="userType" class="form-control" onchange="toggleLoginFields()">
                        <option value="">Select...</option>
                        <option value="agent">Travel Agent</option>
                        <option value="admin">Administrator</option>
                    </select>
                </div>
                
                <div id="agentSelection" class="hidden">
                    <div class="form-group">
                        <label>Select Your Location</label>
                        <div class="agent-select-card">
                            <div class="agent-option" onclick="selectAgent('Dejene Tilahun', 'Dambi Dollo')">
                                <img src="https://randomuser.me/api/portraits/men/32.jpg" alt="Dejene Tilahun" class="agent-photo">
                                <h3>Dejene Tilahun</h3>
                                <p>Dambi Dollo</p>
                            </div>
                            <div class="agent-option" onclick="selectAgent('Beka Terefu', 'Gimbi')">
                                <img src="https://randomuser.me/api/portraits/men/22.jpg" alt="Beka Terefu" class="agent-photo">
                                <h3>Beka Terefu</h3>
                                <p>Gimbi</p>
                            </div>
                            <div class="agent-option" onclick="selectAgent('Bayisa Gemechu', 'Nekemte')">
                                <img src="https://randomuser.me/api/portraits/men/44.jpg" alt="Bayisa Gemechu" class="agent-photo">
                                <h3>Bayisa Gemechu</h3>
                                <p>Nekemte</p>
                            </div>
                            <div class="agent-option" onclick="selectAgent('Obsa Wanna', 'Finfine')">
                                <img src="https://randomuser.me/api/portraits/men/55.jpg" alt="Obsa Wanna" class="agent-photo">
                                <h3>Obsa Wanna</h3>
                                <p>Finfine</p>
                            </div>
                            <div class="agent-option" onclick="selectAgent('Mamush Tesiso', 'Shashemene')">
                                <img src="https://randomuser.me/api/portraits/men/66.jpg" alt="Mamush Tesiso" class="agent-photo">
                                <h3>Mamush Tesiso</h3>
                                <p>Shashemene</p>
                            </div>
                            <div class="agent-option" onclick="selectAgent('Yosef Borhanu', 'Hawasa')">
                                <img src="https://randomuser.me/api/portraits/men/77.jpg" alt="Yosef Borhanu" class="agent-photo">
                                <h3>Yosef Borhanu</h3>
                                <p>Hawasa</p>
                            </div>
                            <div class="agent-option" onclick="selectAgent('Felmeta Haimed', 'Moyale')">
                                <img src="https://randomuser.me/api/portraits/women/45.jpg" alt="Felmeta Haimed" class="agent-photo">
                                <h3>Felmeta Haimed</h3>
                                <p>Moyale</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="agentPassword">Agent Password</label>
                        <input type="password" id="agentPassword" class="form-control" placeholder="Enter your password">
                    </div>
                    
                    <button class="btn btn-primary btn-block" onclick="loginAsAgent()">
                        <i class="fas fa-sign-in-alt"></i> Login as Agent
                    </button>
                </div>
                
                <div id="adminLogin" class="hidden">
                    <div class="form-group">
                        <label for="adminUsername">Admin Username</label>
                        <input type="text" id="adminUsername" class="form-control" placeholder="Enter admin username">
                    </div>
                    
                    <div class="form-group">
                        <label for="adminPassword">Admin Password</label>
                        <input type="password" id="adminPassword" class="form-control" placeholder="Enter admin password">
                    </div>
                    
                    <button class="btn btn-primary btn-block" onclick="loginAsAdmin()">
                        <i class="fas fa-lock"></i> Login as Administrator
                    </button>
                </div>
                
                <div class="button-group" style="margin-top: 20px;">
                    <button class="btn cloudflare-btn" onclick="openCloudflareDocs()">
                        <i class="fas fa-cloud"></i> Cloudflare Pages Docs
                    </button>
                </div>
                
                <div style="margin-top: 20px; font-size: 12px; color: var(--gray);">
                    <p><i class="fas fa-info-circle"></i> Real-time notifications to Telegram bot. Contact administrator for password reset.</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Main Application (Hidden by default) -->
    <div id="mainApp" class="container hidden">
        <!-- Header -->
        <header class="header no-print">
            <div>
                <h1 style="font-size: 20px; margin-bottom: 5px;">Tefera Yadeta Travel Agent</h1>
                <p style="font-size: 14px; opacity: 0.9;">Cloudflare Pages + Telegram Bot System</p>
                <div style="display: flex; gap: 15px; margin-top: 10px;">
                    <div class="sync-status" id="syncStatus">
                        <i class="fas fa-cloud"></i> <span>Cloudflare Pages Active</span>
                    </div>
                    <div class="telegram-status" id="telegramStatus">
                        <i class="fab fa-telegram"></i> <span>Telegram: Testing...</span>
                    </div>
                </div>
            </div>
            <div class="user-info">
                <div class="user-avatar" id="userAvatar">
                    <!-- Profile photo will be inserted here -->
                </div>
                <div>
                    <div style="font-weight: 600;" id="userName">User</div>
                    <div style="font-size: 12px; opacity: 0.8;" id="userRole">Role</div>
                </div>
                <button class="btn btn-warning" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
            </div>
        </header>
        
        <!-- Agent Dashboard -->
        <div id="agentDashboard" class="hidden">
            <div class="main-layout">
                <!-- Passenger Registration Form -->
                <div class="card no-print">
                    <div class="card-title">
                        <i class="fas fa-user-plus"></i>
                        <h2>Register Passenger <span id="agentLocationBadge" class="badge badge-primary"></span></h2>
                    </div>
                    
                    <div class="profile-section">
                        <img id="agentProfilePhoto" src="" alt="Agent Photo" class="profile-photo">
                        <div>
                            <h3 id="agentFullName">Agent Name</h3>
                            <p id="agentLocationText">Location</p>
                            <div style="font-size: 12px; color: var(--gray);">
                                <i class="fab fa-telegram"></i> Telegram Bot: <span id="telegramBotName">GetuSample_Bot</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="sync-panel">
                        <h4><i class="fas fa-cloud"></i> Cloudflare Pages Deployment</h4>
                        <div style="margin-bottom: 10px;">
                            <div style="color: var(--gray); font-size: 12px; margin-bottom: 5px;">Deployment Status:</div>
                            <div style="display: flex; gap: 10px;">
                                <div style="padding: 8px 15px; background: #e8f5e9; border-radius: 6px; flex: 1; font-size: 14px;">
                                    <i class="fas fa-check-circle" style="color: #27ae60;"></i> Active on Cloudflare Pages
                                </div>
                            </div>
                        </div>
                        <div style="font-size: 11px; color: var(--gray);">
                            <p><i class="fas fa-info-circle"></i> This system is deployed on Cloudflare Pages with automatic Telegram notifications.</p>
                        </div>
                    </div>
                    
                    <div class="route-info">
                        <i class="fas fa-info-circle"></i> You can select any departure and arrival locations. Phone number is optional.
                    </div>
                    
                    <form id="passengerForm">
                        <div class="form-group">
                            <label for="passengerName" class="required">Passenger Full Name</label>
                            <input type="text" id="passengerName" class="form-control" placeholder="Enter passenger name" required>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="passengerPhone" class="optional">Phone Number</label>
                                <input type="tel" id="passengerPhone" class="form-control" placeholder="091 XXX XXXX (optional)">
                            </div>
                            <div class="form-group">
                                <label for="travelDate" class="required">Travel Date</label>
                                <input type="date" id="travelDate" class="form-control" required>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="departureCity" class="required">Departure City</label>
                                <select id="departureCity" class="form-control" required onchange="calculateFare()">
                                    <option value="">Select departure city</option>
                                    <!-- All locations will be populated here -->
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="arrivalCity" class="required">Arrival City</label>
                                <select id="arrivalCity" class="form-control" required onchange="calculateFare()">
                                    <option value="">Select arrival city</option>
                                    <!-- All locations will be populated here -->
                                </select>
                            </div>
                        </div>
                        
                        <!-- Fare Display -->
                        <div id="fareDisplay" class="fare-display" style="display: none;">
                            <div class="fare-label">Calculated Fare</div>
                            <div class="fare-amount"><span id="fareAmount">0</span> <span class="fare-currency">ETB</span></div>
                            <p style="margin-top: 10px; color: var(--gray); font-size: 13px;">
                                <i class="fas fa-route"></i> Route: <span id="routeDisplay"></span>
                            </p>
                        </div>
                        
                        <div class="button-group">
                            <button type="button" class="btn btn-accent" onclick="calculateFare()">
                                <i class="fas fa-calculator"></i> Calculate Fare
                            </button>
                            <button type="button" class="btn btn-success" onclick="savePassenger()">
                                <i class="fas fa-save"></i> Save Passenger
                            </button>
                            <button type="button" class="btn btn-light" onclick="clearForm()">
                                <i class="fas fa-times"></i> Clear Form
                            </button>
                        </div>
                    </form>
                    
                    <!-- Daily Summary -->
                    <div class="summary-cards">
                        <div class="summary-card">
                            <div class="summary-value" id="myPassengerCount">0</div>
                            <div class="summary-label">My Passengers Today</div>
                        </div>
                        <div class="summary-card">
                            <div class="summary-value" id="myTotalRevenue">0 ETB</div>
                            <div class="summary-label">My Total Revenue</div>
                        </div>
                        <div class="summary-card">
                            <div class="summary-value" id="myAvgFare">0 ETB</div>
                            <div class="summary-label">My Average Fare</div>
                        </div>
                    </div>
                </div>
                
                <!-- Agent Reports & Information -->
                <div class="card no-print">
                    <div class="card-title">
                        <i class="fas fa-chart-pie"></i>
                        <h2>My Performance Report</h2>
                    </div>
                    
                    <div style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                        <h3 style="margin-bottom: 10px; color: var(--primary);">Agent Statistics</h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                            <div>
                                <div style="color: var(--gray); font-size: 12px;">Total Passengers (All Time):</div>
                                <div style="font-size: 24px; font-weight: 700; color: var(--accent);" id="totalAllTimePassengers">0</div>
                            </div>
                            <div>
                                <div style="color: var(--gray); font-size: 12px;">Total Revenue (All Time):</div>
                                <div style="font-size: 24px; font-weight: 700; color: var(--success);" id="totalAllTimeRevenue">0 ETB</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card-title" style="margin-top: 20px;">
                        <i class="fas fa-file-export"></i>
                        <h2>Export & Reporting</h2>
                    </div>
                    
                    <div class="button-group">
                        <button class="btn telegram-btn" onclick="sendTelegramReport()" id="telegramReportBtn">
                            <i class="fab fa-telegram"></i> Send Telegram Report
                        </button>
                        <button class="btn pdf-btn" onclick="generatePDFReport()">
                            <i class="fas fa-file-pdf"></i> PDF Report
                        </button>
                        <button class="btn email-btn" onclick="emailReport()">
                            <i class="fas fa-envelope"></i> Email
                        </button>
                    </div>
                    
                    <div style="margin-top: 20px;">
                        <button class="btn btn-primary btn-block" onclick="printAgentReport()">
                            <i class="fas fa-print"></i> Print My Report
                        </button>
                    </div>
                    
                    <div class="card-title" style="margin-top: 30px;">
                        <i class="fab fa-telegram"></i>
                        <h2>Telegram Bot Settings</h2>
                    </div>
                    
                    <div style="background: var(--light-gray); padding: 15px; border-radius: 8px;">
                        <div style="margin-bottom: 15px;">
                            <div style="color: var(--gray); font-size: 12px; margin-bottom: 5px;">Bot Username:</div>
                            <div style="display: flex; gap: 10px;">
                                <input type="text" id="telegramBotUsername" class="form-control" value="GetuSample_Bot" readonly>
                                <button class="btn btn-accent" onclick="testTelegramBot()" style="white-space: nowrap;">
                                    <i class="fas fa-bolt"></i> Test Bot
                                </button>
                            </div>
                        </div>
                        <div style="margin-bottom: 15px;">
                            <div style="color: var(--gray); font-size: 12px; margin-bottom: 5px;">Admin Chat ID:</div>
                            <input type="text" id="telegramChatId" class="form-control" value="8550135384" readonly>
                        </div>
                        <div style="font-size: 12px; color: var(--gray);">
                            <p><i class="fas fa-info-circle"></i> Real-time notifications are sent to Telegram bot whenever a passenger is registered.</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- My Passenger Records -->
            <div class="card">
                <div class="card-title">
                    <i class="fas fa-list-alt"></i>
                    <h2>My Today's Passengers <span class="badge badge-primary" id="myRecordsCount">0 records</span></h2>
                </div>
                
                <div class="data-table-container">
                    <table class="data-table" id="myPassengerTable">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Passenger Name</th>
                                <th>Phone</th>
                                <th>Route</th>
                                <th>Fare (ETB)</th>
                                <th>Time</th>
                                <th>Telegram Sent</th>
                                <th class="action-cell no-print">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="myTableBody">
                            <!-- Data will be inserted here -->
                        </tbody>
                    </table>
                    
                    <div id="myEmptyState" class="empty-state">
                        <i class="fas fa-user-friends"></i>
                        <h3>No passengers registered today</h3>
                        <p>Register your first passenger using the form above</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Admin Dashboard -->
        <div id="adminDashboard" class="hidden">
            <div class="card">
                <div class="card-title">
                    <i class="fas fa-chart-bar"></i>
                    <h2>Administrator Dashboard</h2>
                </div>
                
                <div class="sync-panel">
                    <h4><i class="fas fa-cloud"></i> Cloudflare Pages + Telegram Integration</h4>
                    <div style="display: flex; gap: 10px; margin-bottom: 10px; flex-wrap: wrap;">
                        <button class="btn btn-success" onclick="backupAllData()">
                            <i class="fas fa-download"></i> Backup All Data
                        </button>
                        <button class="btn btn-primary" onclick="sendAdminTelegramReport()">
                            <i class="fab fa-telegram"></i> Telegram Admin Report
                        </button>
                        <button class="btn cloudflare-btn" onclick="openCloudflareDocs()">
                            <i class="fas fa-cloud"></i> Cloudflare Docs
                        </button>
                    </div>
                    <div style="font-size: 12px; color: var(--gray);">
                        <p><i class="fas fa-info-circle"></i> System deployed on Cloudflare Pages with Telegram bot integration.</p>
                    </div>
                </div>
                
                <div class="summary-cards">
                    <div class="summary-card">
                        <div class="summary-value" id="totalPassengersAll">0</div>
                        <div class="summary-label">Total Passengers Today</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-value" id="totalRevenueAll">0 ETB</div>
                        <div class="summary-label">Total Revenue Today</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-value" id="activeAgents">7</div>
                        <div class="summary-label">Active Agents</div>
                    </div>
                </div>
                
                <!-- Telegram Bot Info -->
                <div class="card-title" style="margin-top: 30px;">
                    <i class="fab fa-telegram"></i>
                    <h2>Telegram Bot Information</h2>
                </div>
                
                <div style="background: #e3f2fd; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div>
                            <div style="color: var(--gray); font-size: 12px;">Bot Username:</div>
                            <div style="font-size: 16px; font-weight: 600; color: var(--dark);">@GetuSample_Bot</div>
                        </div>
                        <div>
                            <div style="color: var(--gray); font-size: 12px;">Admin Chat ID:</div>
                            <div style="font-size: 16px; font-weight: 600; color: var(--dark);">8550135384</div>
                        </div>
                        <div>
                            <div style="color: var(--gray); font-size: 12px;">Bot Token:</div>
                            <div style="font-size: 12px; font-weight: 600; color: var(--dark); word-break: break-all;">8550135384:AAF0ACGMdLmNBdmJGwDMWd8TFrAh9S_Sr28</div>
                        </div>
                        <div>
                            <div style="color: var(--gray); font-size: 12px;">Status:</div>
                            <div style="font-size: 16px; font-weight: 600; color: #27ae60;" id="botStatus">Connected</div>
                        </div>
                    </div>
                    <button class="btn telegram-btn" style="margin-top: 15px;" onclick="testTelegramBot()">
                        <i class="fas fa-bolt"></i> Test Telegram Bot Connection
                    </button>
                </div>
                
                <!-- Agent Performance -->
                <div class="card-title" style="margin-top: 30px;">
                    <i class="fas fa-users"></i>
                    <h2>Agent Performance Today</h2>
                </div>
                
                <div class="admin-panel" id="agentPerformance">
                    <!-- Filled by JavaScript -->
                </div>
                
                <!-- All Passenger Records -->
                <div class="card-title" style="margin-top: 30px;">
                    <i class="fas fa-database"></i>
                    <h2>All Passenger Records <span class="badge badge-primary" id="allRecordsCount">0 records</span></h2>
                </div>
                
                <div class="data-table-container">
                    <table class="data-table" id="allPassengerTable">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Passenger</th>
                                <th>Phone</th>
                                <th>Route</th>
                                <th>Fare</th>
                                <th>Agent</th>
                                <th>Time</th>
                                <th class="no-print">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="allTableBody">
                            <!-- Data will be inserted here -->
                        </tbody>
                    </table>
                    
                    <div id="allEmptyState" class="empty-state">
                        <i class="fas fa-database"></i>
                        <h3>No passenger records found</h3>
                        <p>Agents will appear here when they register passengers</p>
                    </div>
                </div>
                
                <div class="button-group" style="margin-top: 30px;">
                    <button class="btn btn-success" onclick="exportAllData()">
                        <i class="fas fa-file-excel"></i> Export All Data
                    </button>
                    <button class="btn btn-primary" onclick="printMasterReport()">
                        <i class="fas fa-print"></i> Print Master Report
                    </button>
                    <button class="btn btn-warning" onclick="clearAllData()">
                        <i class="fas fa-trash"></i> Clear All Data
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Footer -->
        <div class="footer no-print">
            <p>Tefera Yadeta Travel Agent &copy; <span id="currentYear"></span> | Cloudflare Pages + Telegram Bot System</p>
            <p style="font-size: 11px; margin-top: 5px; opacity: 0.7;">Contact Admin: +251912631134 | Telegram: @GetuSample_Bot</p>
            <p style="font-size: 10px; margin-top: 5px; opacity: 0.5;">Deployed on Cloudflare Pages with real-time Telegram notifications</p>
        </div>
    </div>
    
    <!-- Toast Notification -->
    <div id="toast" class="toast no-print">
        <i class="fas fa-check-circle"></i>
        <div>
            <strong id="toastTitle">Success!</strong>
            <p id="toastMessage">Operation completed</p>
        </div>
    </div>
    
    <script>
        // ========== SYSTEM CONFIGURATION ==========
        const ADMIN_PASSWORD = "Admin@2024";
        const ADMIN_USERNAME = "admin";
        const ADMIN_EMAIL = "yadetatefera@gmail.com";
        
        // Telegram Bot Configuration
        const TELEGRAM_BOT_TOKEN = "8550135384:AAF0ACGMdLmNBdmJGwDMWd8TFrAh9S_Sr28";
        const TELEGRAM_BOT_USERNAME = "GetuSample_Bot";
        const TELEGRAM_CHAT_ID = "8550135384";
        const TELEGRAM_API_URL = `https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}`;
        
        // Agent passwords
        const AGENT_PASSWORDS = {
            "Dejene Tilahun": "Dambi@2024",
            "Beka Terefu": "Gimbi@2024", 
            "Bayisa Gemechu": "Nekemte@2024",
            "Obsa Wanna": "Finfine@2024",
            "Mamush Tesiso": "Shashemene@2024",
            "Yosef Borhanu": "Hawasa@2024",
            "Felmeta Haimed": "Moyale@2024"
        };
        
        // Agent profile photos
        const AGENT_PHOTOS = {
            "Dejene Tilahun": "https://randomuser.me/api/portraits/men/32.jpg",
            "Beka Terefu": "https://randomuser.me/api/portraits/men/22.jpg",
            "Bayisa Gemechu": "https://randomuser.me/api/portraits/men/44.jpg",
            "Obsa Wanna": "https://randomuser.me/api/portraits/men/55.jpg",
            "Mamush Tesiso": "https://randomuser.me/api/portraits/men/66.jpg",
            "Yosef Borhanu": "https://randomuser.me/api/portraits/men/77.jpg",
            "Felmeta Haimed": "https://randomuser.me/api/portraits/women/45.jpg"
        };
        
        // All available locations
        const ALL_LOCATIONS = [
            "Dambi Dolo", "Gimbi", "Nekemte", "Finfine", "Bako", 
            "Canqaa", "Ayira", "Shashemene", "Hawasa", "Moyale", 
            "Dilla", "Bule-Hora", "Yabello"
        ];
        
        // Fare database
        const fareDatabase = {
            "Dambi Dolo to Gimbi": 800,
            "Gimbi to Dambi Dolo": 800,
            "Dambi Dolo to Nekemte": 1200,
            "Nekemte to Dambi Dolo": 1200,
            "Dambi Dolo to Finfine": 2400,
            "Finfine to Dambi Dolo": 2400,
            "Dambi Dolo to Bako": 1700,
            "Bako to Dambi Dolo": 1700,
            "Canqaa to Finfine": 2250,
            "Finfine to Canqaa": 2250,
            "Ayira to Finfine": 1900,
            "Finfine to Ayira": 1900,
            "Gimbi to Finfine": 1625,
            "Finfine to Gimbi": 1625,
            "Nekemte to Finfine": 1200,
            "Finfine to Nekemte": 1200,
            "Shashemene to Finfine": 1100,
            "Finfine to Shashemene": 1100,
            "Shashemene to Moyale": 1500,
            "Moyale to Shashemene": 1500,
            "Hawasa to Finfine": 1100,
            "Finfine to Hawasa": 1100,
            "Hawasa to Moyale": 1500,
            "Moyale to Hawasa": 1500,
            "Moyale to Finfine": 2500,
            "Finfine to Moyale": 2500,
            "Moyale to Dilla": 1200,
            "Dilla to Moyale": 1200,
            "Moyale to Bule-Hora": 900,
            "Bule-Hora to Moyale": 900,
            "Moyale to Yabello": 600,
            "Yabello to Moyale": 600
        };
        
        // ========== GLOBAL VARIABLES ==========
        let currentUser = null;
        let allPassengers = JSON.parse(localStorage.getItem('teferaAllPassengers')) || [];
        let telegramBotStatus = "disconnected";
        
        // ========== TELEGRAM BOT FUNCTIONS ==========
        async function sendTelegramMessage(message, chatId = TELEGRAM_CHAT_ID) {
            try {
                const response = await fetch(`${TELEGRAM_API_URL}/sendMessage`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        chat_id: chatId,
                        text: message,
                        parse_mode: 'HTML'
                    })
                });
                
                const data = await response.json();
                
                if (data.ok) {
                    updateTelegramStatus('connected', 'Telegram: Connected');
                    return { success: true, messageId: data.result.message_id };
                } else {
                    updateTelegramStatus('disconnected', 'Telegram: Error');
                    console.error('Telegram API Error:', data);
                    return { success: false, error: data.description };
                }
            } catch (error) {
                console.error('Failed to send Telegram message:', error);
                updateTelegramStatus('disconnected', 'Telegram: Offline');
                return { success: false, error: error.message };
            }
        }
        
        async function testTelegramBot() {
            const testBtn = document.getElementById('telegramReportBtn') || event.currentTarget;
            const originalText = testBtn.innerHTML;
            testBtn.innerHTML = '<div class="spinner"></div> Testing...';
            testBtn.disabled = true;
            
            const testMessage = ` <b>Telegram Bot Test</b>\n` +
                              ` <b>System:</b> Tefera Yadeta Travel\n` +
                              ` <b>Time:</b> ${new Date().toLocaleString()}\n` +
                              ` <b>Status:</b> Cloudflare Pages Active\n` +
                              ` <b>User:</b> ${currentUser ? currentUser.name : 'Test'}`;
            
            const result = await sendTelegramMessage(testMessage);
            
            if (result.success) {
                showToast('Telegram bot connection successful!', 'success');
                updateTelegramStatus('connected', 'Telegram: Connected');
            } else {
                showToast('Telegram bot connection failed: ' + result.error, 'warning');
                updateTelegramStatus('disconnected', 'Telegram: Error');
            }
            
            setTimeout(() => {
                testBtn.innerHTML = originalText;
                testBtn.disabled = false;
            }, 2000);
        }
        
        function updateTelegramStatus(status, message) {
            telegramBotStatus = status;
            const telegramStatusEl = document.getElementById('telegramStatus');
            if (telegramStatusEl) {
                telegramStatusEl.className = `telegram-status ${status}`;
                telegramStatusEl.innerHTML = `<i class="fab fa-telegram"></i> <span>${message}</span>`;
            }
            
            const botStatusEl = document.getElementById('botStatus');
            if (botStatusEl) {
                botStatusEl.textContent = status === 'connected' ? 'Connected' : 'Disconnected';
                botStatusEl.style.color = status === 'connected' ? '#27ae60' : '#e74c3c';
            }
        }
        
        async function sendPassengerNotification(passenger) {
            const message = ` <b>NEW PASSENGER REGISTERED</b>\n\n` +
                          ` <b>Agent:</b> ${passenger.agent}\n` +
                          ` <b>Location:</b> ${passenger.agentLocation}\n` +
                          ` <b>Passenger:</b> ${passenger.name}\n` +
                          ` <b>Phone:</b> ${passenger.phone}\n` +
                          ` <b>Route:</b> ${passenger.route}\n` +
                          ` <b>Fare:</b> ${passenger.fare.toLocaleString()} ETB\n` +
                          ` <b>Date:</b> ${passenger.date}\n` +
                          ` <b>Time:</b> ${passenger.time}\n\n` +
                          ` <i>Today's Total: ${allPassengers.filter(p => p.date === passenger.date && p.agent === passenger.agent).length} passengers</i>`;
            
            return await sendTelegramMessage(message);
        }
        
        async function sendTelegramReport() {
            const today = new Date().toISOString().split('T')[0];
            const myPassengers = allPassengers.filter(p => 
                p.agent === currentUser.name && p.date === today
            );
            
            if (myPassengers.length === 0) {
                showToast('No passengers to report today.', 'warning');
                return;
            }
            
            const totalRevenue = myPassengers.reduce((sum, p) => sum + p.fare, 0);
            
            let message = ` <b>DAILY REPORT - ${currentUser.name}</b>\n\n`;
            message += ` <b>Location:</b> ${currentUser.location}\n`;
            message += ` <b>Date:</b> ${today}\n`;
            message += ` <b>Total Passengers:</b> ${myPassengers.length}\n`;
            message += ` <b>Total Revenue:</b> ${totalRevenue.toLocaleString()} ETB\n\n`;
            message += `<b>Passenger List:</b>\n`;
            
            myPassengers.forEach((p, i) => {
                const phoneDisplay = p.phone === 'Not provided' ? 'No phone' : p.phone;
                message += `${i+1}. ${p.name} - ${phoneDisplay} - ${p.route} - ${p.fare.toLocaleString()} ETB\n`;
            });
            
            message += `\n <b>Summary:</b>\n`;
            message += ` Average Fare: ${Math.round(totalRevenue / myPassengers.length).toLocaleString()} ETB\n`;
            message += ` Last Sync: ${new Date().toLocaleTimeString()}\n`;
            message += ` System: Cloudflare Pages`;
            
            const result = await sendTelegramMessage(message);
            
            if (result.success) {
                showToast('Telegram report sent successfully!', 'success');
            } else {
                showToast('Failed to send Telegram report', 'warning');
            }
        }
        
        async function sendAdminTelegramReport() {
            const today = new Date().toISOString().split('T')[0];
            const todayPassengers = allPassengers.filter(p => p.date === today);
            
            if (todayPassengers.length === 0) {
                showToast('No data to report today.', 'warning');
                return;
            }
            
            const totalRevenue = todayPassengers.reduce((sum, p) => sum + p.fare, 0);
            const agentGroups = {};
            todayPassengers.forEach(p => {
                if (!agentGroups[p.agent]) {
                    agentGroups[p.agent] = { count: 0, revenue: 0 };
                }
                agentGroups[p.agent].count++;
                agentGroups[p.agent].revenue += p.fare;
            });
            
            let message = ` <b>ADMIN DAILY REPORT</b>\n\n`;
            message += ` <b>Date:</b> ${today}\n`;
            message += ` <b>Total Passengers:</b> ${todayPassengers.length}\n`;
            message += ` <b>Total Revenue:</b> ${totalRevenue.toLocaleString()} ETB\n\n`;
            message += `<b>Agent Performance:</b>\n`;
            
            Object.keys(agentGroups).forEach(agent => {
                message += ` ${agent}: ${agentGroups[agent].count} passengers, ${agentGroups[agent].revenue.toLocaleString()} ETB\n`;
            });
            
            message += `\n <b>System Status:</b>\n`;
            message += ` Cloudflare Pages: Active \n`;
            message += ` Telegram Bot: ${telegramBotStatus === 'connected' ? 'Connected ' : 'Disconnected '}\n`;
            message += ` Report Time: ${new Date().toLocaleString()}`;
            
            const result = await sendTelegramMessage(message);
            
            if (result.success) {
                showToast('Admin Telegram report sent!', 'success');
            } else {
                showToast('Failed to send admin report', 'warning');
            }
        }
        
        // ========== PAGE INITIALIZATION ==========
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('currentYear').textContent = new Date().getFullYear();
            
            const today = new Date().toISOString().split('T')[0];
            if (document.getElementById('travelDate')) {
                document.getElementById('travelDate').value = today;
                document.getElementById('travelDate').min = today;
            }
            
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                showMainApp();
            }
            
            updateTelegramStatus('disconnected', 'Telegram: Testing...');
            setTimeout(() => testTelegramBot(), 1000);
        });
        
        function openCloudflareDocs() {
            window.open('https://developers.cloudflare.com/pages/', '_blank');
        }
        
        // ========== LOGIN FUNCTIONS ==========
        function toggleLoginFields() {
            const userType = document.getElementById('userType').value;
            document.getElementById('agentSelection').classList.add('hidden');
            document.getElementById('adminLogin').classList.add('hidden');
            
            if (userType === 'agent') {
                document.getElementById('agentSelection').classList.remove('hidden');
            } else if (userType === 'admin') {
                document.getElementById('adminLogin').classList.remove('hidden');
            }
        }
        
        function selectAgent(name, location) {
            document.querySelectorAll('.agent-option').forEach(option => {
                option.classList.remove('selected');
            });
            
            event.currentTarget.classList.add('selected');
            
            localStorage.setItem('selectedAgent', JSON.stringify({ name, location }));
        }
        
        function loginAsAgent() {
            const selectedAgent = JSON.parse(localStorage.getItem('selectedAgent'));
            const password = document.getElementById('agentPassword').value;
            
            if (!selectedAgent) {
                showToast('Please select an agent', 'warning');
                return;
            }
            
            if (!password) {
                showToast('Please enter your password', 'warning');
                return;
            }
            
            if (AGENT_PASSWORDS[selectedAgent.name] !== password) {
                showToast('Incorrect password. Contact administrator.', 'warning');
                return;
            }
            
            let agentPhoto = localStorage.getItem(`agent_photo_${selectedAgent.name}`);
            if (!agentPhoto) {
                agentPhoto = AGENT_PHOTOS[selectedAgent.name];
            }
            
            currentUser = {
                type: 'agent',
                name: selectedAgent.name,
                location: selectedAgent.location,
                photo: agentPhoto,
                hasFullAccess: true
            };
            
            localStorage.setItem('currentUser', JSON.stringify(currentUser));
            showMainApp();
            showToast(`Welcome ${selectedAgent.name}! Telegram bot connected.`, 'success');
        }
        
        function loginAsAdmin() {
            const username = document.getElementById('adminUsername').value;
            const password = document.getElementById('adminPassword').value;
            
            if (!username || !password) {
                showToast('Please enter admin credentials', 'warning');
                return;
            }
            
            if (username !== ADMIN_USERNAME || password !== ADMIN_PASSWORD) {
                showToast('Invalid admin credentials', 'warning');
                return;
            }
            
            currentUser = {
                type: 'admin',
                name: 'Administrator',
                location: 'All Locations',
                photo: 'https://randomuser.me/api/portraits/men/1.jpg',
                hasFullAccess: true
            };
            
            localStorage.setItem('currentUser', JSON.stringify(currentUser));
            showMainApp();
            showToast('Welcome Administrator! Telegram bot connected.', 'success');
        }
        
        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                localStorage.removeItem('currentUser');
                localStorage.removeItem('selectedAgent');
                currentUser = null;
                location.reload();
            }
        }
        
        // ========== SHOW MAIN APPLICATION ==========
        function showMainApp() {
            document.getElementById('loginPage').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            
            document.getElementById('userName').textContent = currentUser.name;
            document.getElementById('userRole').textContent = currentUser.type === 'admin' ? 'Administrator' : 'Travel Agent';
            
            const userAvatar = document.getElementById('userAvatar');
            userAvatar.innerHTML = `<img src="${currentUser.photo}" alt="${currentUser.name}">`;
            
            if (currentUser.type === 'agent') {
                document.getElementById('agentDashboard').classList.remove('hidden');
                document.getElementById('adminDashboard').classList.add('hidden');
                setupAgentDashboard();
            } else {
                document.getElementById('agentDashboard').classList.add('hidden');
                document.getElementById('adminDashboard').classList.remove('hidden');
                setupAdminDashboard();
            }
        }
        
        // ========== AGENT DASHBOARD FUNCTIONS ==========
        function setupAgentDashboard() {
            document.getElementById('agentFullName').textContent = currentUser.name;
            document.getElementById('agentLocationText').textContent = currentUser.location;
            document.getElementById('agentProfilePhoto').src = currentUser.photo;
            document.getElementById('agentLocationBadge').textContent = currentUser.location;
            
            populateLocationDropdowns();
            updateAgentStatistics();
            updateAllTimeStatistics();
        }
        
        function populateLocationDropdowns() {
            const departureSelect = document.getElementById('departureCity');
            const arrivalSelect = document.getElementById('arrivalCity');
            
            departureSelect.innerHTML = '<option value="">Select departure city</option>';
            arrivalSelect.innerHTML = '<option value="">Select arrival city</option>';
            
            ALL_LOCATIONS.forEach(location => {
                const departureOption = document.createElement('option');
                departureOption.value = location;
                departureOption.textContent = location;
                departureSelect.appendChild(departureOption.cloneNode(true));
                
                const arrivalOption = departureOption.cloneNode(true);
                arrivalSelect.appendChild(arrivalOption);
            });
            
            departureSelect.value = currentUser.location;
        }
        
        function calculateFare() {
            const departure = document.getElementById('departureCity').value;
            const arrival = document.getElementById('arrivalCity').value;
            
            if (!departure || !arrival) {
                showToast('Please select both departure and arrival locations.', 'warning');
                return;
            }
            
            if (departure === arrival) {
                showToast('Departure and arrival cannot be the same.', 'warning');
                document.getElementById('fareDisplay').style.display = 'none';
                return;
            }
            
            const routeKey = `${departure} to ${arrival}`;
            const reverseKey = `${arrival} to ${departure}`;
            
            let fare = fareDatabase[routeKey] || fareDatabase[reverseKey];
            
            if (fare) {
                document.getElementById('fareAmount').textContent = fare.toLocaleString();
                document.getElementById('routeDisplay').textContent = `${departure}  ${arrival}`;
                document.getElementById('fareDisplay').style.display = 'block';
            } else {
                showToast('Fare not found for this route. Please select a different route or contact administrator.', 'warning');
                document.getElementById('fareDisplay').style.display = 'none';
            }
        }
        
        async function savePassenger() {
            const passengerName = document.getElementById('passengerName').value.trim();
            const passengerPhone = document.getElementById('passengerPhone').value.trim();
            const travelDate = document.getElementById('travelDate').value;
            const departure = document.getElementById('departureCity').value;
            const arrival = document.getElementById('arrivalCity').value;
            
            if (!passengerName || !travelDate || !departure || !arrival) {
                showToast('Please fill all required fields (Name, Date, Departure, Arrival).', 'warning');
                return;
            }
            
            if (departure === arrival) {
                showToast('Departure and arrival cannot be the same.', 'warning');
                return;
            }
            
            let validPhone = true;
            let formattedPhone = passengerPhone;
            
            if (passengerPhone) {
                const cleanedPhone = passengerPhone.replace(/\s/g, '');
                const phoneRegex = /^09[0-9]{8}$/;
                
                if (!phoneRegex.test(cleanedPhone)) {
                    showToast('Please enter a valid Ethiopian phone number (09XXXXXXXX) or leave it empty.', 'warning');
                    return;
                }
                
                formattedPhone = cleanedPhone.replace(/(\d{3})(\d{3})(\d{3})/, '$1 $2 $3');
            }
            
            const routeKey = `${departure} to ${arrival}`;
            const reverseKey = `${arrival} to ${departure}`;
            const fare = fareDatabase[routeKey] || fareDatabase[reverseKey] || 0;
            
            if (fare === 0) {
                showToast('Could not calculate fare for this route. Please select a different route.', 'warning');
                return;
            }
            
            const passenger = {
                id: Date.now(),
                name: passengerName,
                phone: formattedPhone || 'Not provided',
                departure: departure,
                arrival: arrival,
                route: `${departure}  ${arrival}`,
                fare: fare,
                agent: currentUser.name,
                agentLocation: currentUser.location,
                date: travelDate,
                time: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}),
                timestamp: new Date().toISOString(),
                telegramSent: false
            };
            
            allPassengers.push(passenger);
            localStorage.setItem('teferaAllPassengers', JSON.stringify(allPassengers));
            
            clearForm();
            updateAgentStatistics();
            updateAllTimeStatistics();
            
            showToast(`Passenger "${passengerName}" registered successfully! Fare: ${fare.toLocaleString()} ETB`, 'success');
            
            const telegramResult = await sendPassengerNotification(passenger);
            if (telegramResult.success) {
                passenger.telegramSent = true;
                showToast('Telegram notification sent!', 'success');
            }
        }
        
        function clearForm() {
            document.getElementById('passengerName').value = '';
            document.getElementById('passengerPhone').value = '';
            document.getElementById('departureCity').value = currentUser.location;
            document.getElementById('arrivalCity').value = '';
            document.getElementById('fareDisplay').style.display = 'none';
        }
        
        function updateAgentStatistics() {
            const today = new Date().toISOString().split('T')[0];
            const myPassengers = allPassengers.filter(p => 
                p.agent === currentUser.name && p.date === today
            );
            
            const passengerCount = myPassengers.length;
            const totalRevenue = myPassengers.reduce((sum, p) => sum + p.fare, 0);
            const avgFare = passengerCount > 0 ? Math.round(totalRevenue / passengerCount) : 0;
            
            document.getElementById('myPassengerCount').textContent = passengerCount;
            document.getElementById('myTotalRevenue').textContent = totalRevenue.toLocaleString() + ' ETB';
            document.getElementById('myAvgFare').textContent = avgFare.toLocaleString() + ' ETB';
            document.getElementById('myRecordsCount').textContent = passengerCount + ' records';
            
            updateMyPassengerTable(myPassengers);
        }
        
        function updateAllTimeStatistics() {
            const myAllPassengers = allPassengers.filter(p => p.agent === currentUser.name);
            
            const totalAllTimePassengers = myAllPassengers.length;
            const totalAllTimeRevenue = myAllPassengers.reduce((sum, p) => sum + p.fare, 0);
            
            document.getElementById('totalAllTimePassengers').textContent = totalAllTimePassengers;
            document.getElementById('totalAllTimeRevenue').textContent = totalAllTimeRevenue.toLocaleString() + ' ETB';
        }
        
        function updateMyPassengerTable(passengers) {
            const tableBody = document.getElementById('myTableBody');
            const emptyState = document.getElementById('myEmptyState');
            
            tableBody.innerHTML = '';
            
            if (passengers.length === 0) {
                emptyState.style.display = 'block';
                return;
            }
            
            emptyState.style.display = 'none';
            
            const sortedPassengers = [...passengers].sort((a, b) => b.id - a.id);
            
            sortedPassengers.forEach((passenger, index) => {
                const row = document.createElement('tr');
                
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td><strong>${passenger.name}</strong></td>
                    <td>${passenger.phone}</td>
                    <td class="route-cell">${passenger.route}</td>
                    <td class="fare-cell">${passenger.fare.toLocaleString()} ETB</td>
                    <td>${passenger.time}</td>
                    <td>${passenger.telegramSent ? '' : ''}</td>
                    <td class="action-cell no-print">
                        <button class="btn btn-light" style="padding: 4px 8px; font-size: 11px;" onclick="editMyPassenger(${passenger.id})">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-warning" style="padding: 4px 8px; font-size: 11px; margin-left: 5px;" onclick="deleteMyPassenger(${passenger.id})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                
                tableBody.appendChild(row);
            });
        }
        
        function editMyPassenger(id) {
            const passenger = allPassengers.find(p => p.id === id);
            if (!passenger) return;
            
            document.getElementById('passengerName').value = passenger.name;
            document.getElementById('passengerPhone').value = passenger.phone === 'Not provided' ? '' : passenger.phone;
            document.getElementById('travelDate').value = passenger.date;
            document.getElementById('departureCity').value = passenger.departure;
            document.getElementById('arrivalCity').value = passenger.arrival;
            
            calculateFare();
            
            allPassengers = allPassengers.filter(p => p.id !== id);
            localStorage.setItem('teferaAllPassengers', JSON.stringify(allPassengers));
            
            updateAgentStatistics();
            updateAllTimeStatistics();
            
            showToast('Passenger loaded for editing. Update and save.', 'success');
        }
        
        function deleteMyPassenger(id) {
            if (!confirm('Are you sure you want to delete this passenger?')) return;
            
            allPassengers = allPassengers.filter(p => p.id !== id);
            localStorage.setItem('teferaAllPassengers', JSON.stringify(allPassengers));
            
            updateAgentStatistics();
            updateAllTimeStatistics();
            showToast('Passenger deleted successfully.', 'success');
        }
        
        // ========== AGENT REPORTING FUNCTIONS ==========
        function generatePDFReport() {
            const today = new Date().toISOString().split('T')[0];
            const myPassengers = allPassengers.filter(p => 
                p.agent === currentUser.name && p.date === today
            );
            
            if (myPassengers.length === 0) {
                showToast('No data to generate PDF.', 'warning');
                return;
            }
            
            const totalRevenue = myPassengers.reduce((sum, p) => sum + p.fare, 0);
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            doc.setFontSize(20);
            doc.setTextColor(40, 40, 40);
            doc.text("Tefera Yadeta Travel Agent", 105, 15, { align: "center" });
            
            doc.setFontSize(12);
            doc.setTextColor(100, 100, 100);
            doc.text("Daily Passenger Report", 105, 22, { align: "center" });
            
            doc.setFontSize(10);
            doc.text(`Agent: ${currentUser.name}`, 20, 35);
            doc.text(`Location: ${currentUser.location}`, 20, 40);
            doc.text(`Date: ${today}`, 20, 45);
            doc.text(`Telegram Bot: @GetuSample_Bot`, 20, 50);
            
            doc.setFontSize(11);
            doc.setTextColor(0, 0, 0);
            doc.text("Summary", 20, 60);
            
            doc.setDrawColor(200, 200, 200);
            doc.line(20, 62, 190, 62);
            
            doc.setFontSize(10);
            doc.text(`Total Passengers: ${myPassengers.length}`, 20, 70);
            doc.text(`Total Revenue: ${totalRevenue.toLocaleString()} ETB`, 20, 75);
            
            doc.setFontSize(11);
            doc.text("Passenger Details", 20, 90);
            doc.line(20, 92, 190, 92);
            
            doc.setFontSize(9);
            doc.setTextColor(255, 255, 255);
            doc.setFillColor(44, 62, 80);
            doc.rect(20, 95, 170, 7, 'F');
            doc.text("#", 25, 100);
            doc.text("Name", 35, 100);
            doc.text("Phone", 80, 100);
            doc.text("Route", 120, 100);
            doc.text("Fare (ETB)", 165, 100);
            
            doc.setTextColor(0, 0, 0);
            let yPos = 105;
            
            myPassengers.forEach((passenger, index) => {
                if (yPos > 270) {
                    doc.addPage();
                    yPos = 20;
                }
                
                doc.setFontSize(8);
                doc.text((index + 1).toString(), 25, yPos);
                doc.text(passenger.name.substring(0, 20), 35, yPos);
                doc.text(passenger.phone.substring(0, 15), 80, yPos);
                doc.text(passenger.route.substring(0, 15), 120, yPos);
                doc.text(passenger.fare.toLocaleString(), 165, yPos);
                
                yPos += 6;
            });
            
            doc.setFontSize(8);
            doc.setTextColor(100, 100, 100);
            doc.text(`Generated by Tefera Yadeta Travel System on ${new Date().toLocaleString()}`, 105, 285, { align: "center" });
            doc.text(`Contact: +251912631134 | Telegram: @GetuSample_Bot`, 105, 290, { align: "center" });
            doc.text(`Cloudflare Pages Deployment`, 105, 295, { align: "center" });
            
            doc.save(`Tefera_${currentUser.name}_Report_${today}.pdf`);
            
            showToast('PDF report generated successfully!', 'success');
        }
        
        function emailReport() {
            const today = new Date().toISOString().split('T')[0];
            const myPassengers = allPassengers.filter(p => 
                p.agent === currentUser.name && p.date === today
            );
            
            if (myPassengers.length === 0) {
                showToast('No data to email.', 'warning');
                return;
            }
            
            const totalRevenue = myPassengers.reduce((sum, p) => sum + p.fare, 0);
            
            let emailBody = `Tefera Yadeta Travel - Daily Passenger Report\n\n`;
            emailBody += `Agent: ${currentUser.name}\n`;
            emailBody += `Location: ${currentUser.location}\n`;
            emailBody += `Date: ${today}\n`;
            emailBody += `Total Passengers: ${myPassengers.length}\n`;
            emailBody += `Total Revenue: ${totalRevenue.toLocaleString()} ETB\n`;
            emailBody += `Telegram Bot: @GetuSample_Bot\n\n`;
            emailBody += `Passenger Details:\n`;
            emailBody += `================================\n`;
            
            myPassengers.forEach((p, i) => {
                emailBody += `${i+1}. ${p.name} - ${p.phone} - ${p.route} - ${p.fare.toLocaleString()} ETB\n`;
            });
            
            emailBody += `\n================================\n`;
            emailBody += `Report generated on: ${new Date().toLocaleString()}\n`;
            emailBody += `Contact: +251912631134\n`;
            emailBody += `Cloudflare Pages + Telegram Bot System\n`;
            
            const subject = `Tefera Travel Report - ${currentUser.name} - ${today}`;
            const mailtoLink = `mailto:${ADMIN_EMAIL}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(emailBody)}`;
            
            window.open(mailtoLink, '_blank');
            
            showToast('Email client opened with report. Please send to ' + ADMIN_EMAIL, 'success');
        }
        
        function printAgentReport() {
            const today = new Date().toISOString().split('T')[0];
            const myPassengers = allPassengers.filter(p => 
                p.agent === currentUser.name && p.date === today
            );
            
            if (myPassengers.length === 0) {
                showToast('No data to print.', 'warning');
                return;
            }
            
            const totalRevenue = myPassengers.reduce((sum, p) => sum + p.fare, 0);
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                <head>
                    <title>Tefera Yadeta Travel - ${currentUser.name} Report</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; }
                        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                        th { background: #2c3e50; color: white; }
                        .summary { display: flex; justify-content: space-around; margin: 20px 0; }
                        .header { text-align: center; margin-bottom: 30px; }
                        .footer { margin-top: 30px; text-align: center; color: #666; font-size: 12px; }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1 style="color: #2c3e50;">Tefera Yadeta Travel Agent</h1>
                        <h3>Daily Passenger Report</h3>
                        <p>Date: ${today}</p>
                        <p>Agent: ${currentUser.name} | Location: ${currentUser.location}</p>
                        <p>Telegram Bot: @GetuSample_Bot</p>
                    </div>
                    
                    <div class="summary">
                        <div style="text-align: center;">
                            <div style="font-size: 24px; font-weight: bold;">${myPassengers.length}</div>
                            <div>Total Passengers</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 24px; font-weight: bold;">${totalRevenue.toLocaleString()} ETB</div>
                            <div>Total Revenue</div>
                        </div>
                    </div>
                    
                    <table>
                        <tr style="background: #2c3e50; color: white;">
                            <th style="padding: 10px; border: 1px solid #ddd;">#</th>
                            <th style="padding: 10px; border: 1px solid #ddd;">Passenger Name</th>
                            <th style="padding: 10px; border: 1px solid #ddd;">Phone</th>
                            <th style="padding: 10px; border: 1px solid #ddd;">Route</th>
                            <th style="padding: 10px; border: 1px solid #ddd;">Fare (ETB)</th>
                            <th style="padding: 10px; border: 1px solid #ddd;">Time</th>
                        </tr>
                        ${myPassengers.map((p, i) => `
                            <tr>
                                <td style="padding: 8px; border: 1px solid #ddd;">${i + 1}</td>
                                <td style="padding: 8px; border: 1px solid #ddd;">${p.name}</td>
                                <td style="padding: 8px; border: 1px solid #ddd;">${p.phone}</td>
                                <td style="padding: 8px; border: 1px solid #ddd;">${p.route}</td>
                                <td style="padding: 8px; border: 1px solid #ddd;">${p.fare.toLocaleString()} ETB</td>
                                <td style="padding: 8px; border: 1px solid #ddd;">${p.time}</td>
                            </tr>
                        `).join('')}
                    </table>
                    
                    <div class="footer">
                        <p>Generated by Tefera Yadeta Travel Agent System</p>
                        <p>Contact: +251912631134 | Telegram: @GetuSample_Bot</p>
                        <p>Cloudflare Pages + Telegram Bot System - Report generated on ${new Date().toLocaleString()}</p>
                    </div>
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.focus();
            printWindow.print();
            printWindow.close();
            
            showToast('Print dialog opened. You can save as PDF from print options.', 'success');
        }
        
        function backupAllData() {
            if (allPassengers.length === 0) {
                showToast('No data to backup.', 'warning');
                return;
            }
            
            const backupData = {
                system: "Tefera Yadeta Travel Agent",
                version: "2.0",
                totalPassengers: allPassengers.length,
                totalRevenue: allPassengers.reduce((sum, p) => sum + p.fare, 0),
                agents: Object.keys(AGENT_PASSWORDS),
                passengers: allPassengers,
                backupTime: new Date().toISOString(),
                telegramBot: "@GetuSample_Bot",
                deployment: "Cloudflare Pages"
            };
            
            const dataStr = JSON.stringify(backupData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = `tefera_backup_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showToast('Backup file downloaded!', 'success');
        }
        
        // ========== ADMIN DASHBOARD FUNCTIONS ==========
        function setupAdminDashboard() {
            updateAdminStatistics();
        }
        
        function updateAdminStatistics() {
            const today = new Date().toISOString().split('T')[0];
            const todayPassengers = allPassengers.filter(p => p.date === today);
            
            const totalPassengers = todayPassengers.length;
            const totalRevenue = todayPassengers.reduce((sum, p) => sum + p.fare, 0);
            
            document.getElementById('totalPassengersAll').textContent = totalPassengers;
            document.getElementById('totalRevenueAll').textContent = totalRevenue.toLocaleString() + ' ETB';
            document.getElementById('allRecordsCount').textContent = totalPassengers + ' records';
            
            updateAgentPerformance(todayPassengers);
            updateAllPassengersTable(todayPassengers);
        }
        
        function updateAgentPerformance(passengers) {
            const agentPerformance = document.getElementById('agentPerformance');
            agentPerformance.innerHTML = '';
            
            const agentGroups = {};
            passengers.forEach(p => {
                if (!agentGroups[p.agent]) {
                    agentGroups[p.agent] = {
                        count: 0,
                        revenue: 0,
                        location: p.agentLocation
                    };
                }
                agentGroups[p.agent].count++;
                agentGroups[p.agent].revenue += p.fare;
            });
            
            Object.keys(AGENT_PASSWORDS).forEach(agentName => {
                const agentData = agentGroups[agentName] || { count: 0, revenue: 0, location: getAgentLocation(agentName) };
                
                const card = document.createElement('div');
                card.className = 'admin-card';
                card.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 15px;">
                        <div class="user-avatar" style="width: 50px; height: 50px;">
                            <img src="${AGENT_PHOTOS[agentName]}" alt="${agentName}" style="width: 100%; height: 100%; object-fit: cover;">
                        </div>
                        <div>
                            <div style="font-weight: 600;">${agentName}</div>
                            <div style="font-size: 12px; color: var(--accent);">${agentData.location}</div>
                        </div>
                    </div>
                    
                    <div class="agent-stats">
                        <div>
                            <div style="font-size: 24px; font-weight: 700; color: var(--accent);">${agentData.count}</div>
                            <div style="font-size: 11px; color: var(--gray);">PASSENGERS</div>
                        </div>
                        <div>
                            <div style="font-size: 24px; font-weight: 700; color: var(--success);">${agentData.revenue.toLocaleString()}</div>
                            <div style="font-size: 11px; color: var(--gray);">REVENUE (ETB)</div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 15px;">
                        <button class="btn btn-light btn-block" style="padding: 8px; font-size: 12px;" onclick="viewAgentDetails('${agentName}')">
                            <i class="fas fa-eye"></i> View Details
                        </button>
                    </div>
                `;
                
                agentPerformance.appendChild(card);
            });
        }
        
        function getAgentLocation(agentName) {
            const locations = {
                "Dejene Tilahun": "Dambi Dollo",
                "Beka Terefu": "Gimbi",
                "Bayisa Gemechu": "Nekemte",
                "Obsa Wanna": "Finfine",
                "Mamush Tesiso": "Shashemene",
                "Yosef Borhanu": "Hawasa",
                "Felmeta Haimed": "Moyale"
            };
            return locations[agentName] || "Unknown";
        }
        
        function viewAgentDetails(agentName) {
            const today = new Date().toISOString().split('T')[0];
            const agentPassengers = allPassengers.filter(p => p.agent === agentName && p.date === today);
            
            if (agentPassengers.length === 0) {
                showToast(`No passengers for ${agentName} today.`, 'warning');
                return;
            }
            
            let message = ` *Agent Details: ${agentName}*\n`;
            message += ` Date: ${today}\n\n`;
            message += `*Passenger List:*\n`;
            
            agentPassengers.forEach((p, i) => {
                const phoneDisplay = p.phone === 'Not provided' ? 'No phone' : p.phone;
                message += `${i+1}. ${p.name} - ${phoneDisplay} - ${p.route} - ${p.fare.toLocaleString()} ETB\n`;
            });
            
            const totalRevenue = agentPassengers.reduce((sum, p) => sum + p.fare, 0);
            message += `\n*Total:* ${agentPassengers.length} passengers, ${totalRevenue.toLocaleString()} ETB`;
            
            alert(message);
        }
        
        function updateAllPassengersTable(passengers) {
            const tableBody = document.getElementById('allTableBody');
            const emptyState = document.getElementById('allEmptyState');
            
            tableBody.innerHTML = '';
            
            if (passengers.length === 0) {
                emptyState.style.display = 'block';
                return;
            }
            
            emptyState.style.display = 'none';
            
            const sortedPassengers = [...passengers].sort((a, b) => b.id - a.id);
            
            sortedPassengers.forEach((passenger, index) => {
                const row = document.createElement('tr');
                
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td><strong>${passenger.name}</strong></td>
                    <td>${passenger.phone}</td>
                    <td class="route-cell">${passenger.route}</td>
                    <td class="fare-cell">${passenger.fare.toLocaleString()} ETB</td>
                    <td>${passenger.agent}</td>
                    <td>${passenger.time}</td>
                    <td class="no-print">
                        <button class="btn btn-warning" style="padding: 4px 8px; font-size: 11px;" onclick="deletePassengerAdmin(${passenger.id})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                
                tableBody.appendChild(row);
            });
        }
        
        function deletePassengerAdmin(id) {
            if (!confirm('Are you sure you want to delete this passenger record?')) return;
            
            allPassengers = allPassengers.filter(p => p.id !== id);
            localStorage.setItem('teferaAllPassengers', JSON.stringify(allPassengers));
            
            updateAdminStatistics();
            showToast('Passenger record deleted.', 'success');
        }
        
        function exportAllData() {
            if (allPassengers.length === 0) {
                showToast('No data to export.', 'warning');
                return;
            }
            
            let csv = 'Tefera Yadeta Travel - All Passenger Data\n';
            csv += `Exported on: ${new Date().toLocaleDateString()}\n`;
            csv += `Telegram Bot: @GetuSample_Bot\n`;
            csv += `Deployment: Cloudflare Pages\n\n`;
            csv += 'No.,Passenger Name,Phone,Departure,Arrival,Route,Fare (ETB),Agent,Agent Location,Date,Time,Telegram Sent\n';
            
            allPassengers.forEach((p, i) => {
                csv += `${i+1},"${p.name}","${p.phone}","${p.departure}","${p.arrival}","${p.route}",${p.fare},"${p.agent}","${p.agentLocation}","${p.date}","${p.time}","${p.telegramSent ? 'Yes' : 'No'}"\n`;
            });
            
            downloadCSV(csv, `Tefera_All_Data_${new Date().toISOString().split('T')[0]}.csv`);
        }
        
        function printMasterReport() {
            const today = new Date().toISOString().split('T')[0];
            const todayPassengers = allPassengers.filter(p => p.date === today);
            
            if (todayPassengers.length === 0) {
                showToast('No data to print.', 'warning');
                return;
            }
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(createMasterReportHTML(todayPassengers));
            printWindow.document.close();
            printWindow.focus();
            setTimeout(() => printWindow.print(), 500);
        }
        
        function createMasterReportHTML(passengers) {
            const today = new Date().toLocaleDateString();
            const totalRevenue = passengers.reduce((sum, p) => sum + p.fare, 0);
            
            return `
                <html>
                <head>
                    <title>Tefera Yadeta Travel - Master Report</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 30px; }
                        .header { text-align: center; margin-bottom: 30px; }
                        h1 { color: #2c3e50; }
                        .summary { display: flex; justify-content: space-around; margin: 20px 0; }
                        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                        th, td { border: 1px solid #ddd; padding: 10px; text-align: left; }
                        th { background: #2c3e50; color: white; }
                        .footer { margin-top: 40px; text-align: center; color: #666; }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>Tefera Yadeta Travel Agent</h1>
                        <h3>Master Daily Report - ${today}</h3>
                        <p>Contact: +251912631134 | Telegram: @GetuSample_Bot</p>
                        <p>Deployment: Cloudflare Pages</p>
                    </div>
                    
                    <div class="summary">
                        <div><strong>Total Passengers:</strong> ${passengers.length}</div>
                        <div><strong>Total Revenue:</strong> ${totalRevenue.toLocaleString()} ETB</div>
                        <div><strong>Date:</strong> ${today}</div>
                    </div>
                    
                    <table>
                        <tr>
                            <th>#</th>
                            <th>Passenger</th>
                            <th>Phone</th>
                            <th>Route</th>
                            <th>Fare</th>
                            <th>Agent</th>
                            <th>Time</th>
                        </tr>
                        ${passengers.map((p, i) => `
                            <tr>
                                <td>${i+1}</td>
                                <td>${p.name}</td>
                                <td>${p.phone}</td>
                                <td>${p.route}</td>
                                <td>${p.fare.toLocaleString()} ETB</td>
                                <td>${p.agent}</td>
                                <td>${p.time}</td>
                            </tr>
                        `).join('')}
                    </table>
                    
                    <div class="footer">
                        <p>Generated by Tefera Yadeta Travel Multi-Agent System</p>
                        <p>Cloudflare Pages + Telegram Bot System</p>
                        <p>Report generated on ${new Date().toLocaleString()}</p>
                    </div>
                </body>
                </html>
            `;
        }
        
        function clearAllData() {
            if (!confirm('WARNING: This will delete ALL passenger data from ALL agents. Continue?')) return;
            
            allPassengers = [];
            localStorage.removeItem('teferaAllPassengers');
            
            if (currentUser.type === 'admin') {
                updateAdminStatistics();
            } else {
                updateAgentStatistics();
                updateAllTimeStatistics();
            }
            
            showToast('All data cleared successfully.', 'success');
        }
        
        // ========== UTILITY FUNCTIONS ==========
        function downloadCSV(csv, filename) {
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            
            link.href = url;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showToast(`File "${filename}" downloaded.`, 'success');
        }
        
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const toastTitle = document.getElementById('toastTitle');
            const toastMessage = document.getElementById('toastMessage');
            const toastIcon = toast.querySelector('i');
            
            toastTitle.textContent = type === 'success' ? 'Success!' : 'Warning!';
            toastMessage.textContent = message;
            
            if (type === 'warning') {
                toast.classList.add('warning');
                toastIcon.className = 'fas fa-exclamation-triangle';
            } else {
                toast.classList.remove('warning');
                toastIcon.className = 'fas fa-check-circle';
            }
            
            toast.classList.add('show');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 4000);
        }
    </script>
</body>
</html>